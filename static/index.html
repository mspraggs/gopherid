<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GopherID - Secure SSO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .jwt-part { word-break: break-all; font-family: monospace; }
        .header-part { color: #d63384; } /* Pink for Header */
        .payload-part { color: #6f42c1; } /* Purple for Payload */
        .signature-part { color: #0dcaf0; } /* Blue for Sig */
        .console-bg { background-color: #212529; color: #0f0; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1"><a href="/" class="h1 text-decoration-none text-light">üîê GopherID Identity Provider</a></span>
        <div>
            <a href="/openapi.json" class="btn btn-outline-light btn-sm me-2">API Spec</a>
        </div>
    </div>
</nav>

<div class="container">

    <div class="row justify-content-center" id="login-card">
        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white text-center">
                    <h4>Sign In</h4>
                </div>
                <div class="card-body p-4">
                    <form onsubmit="login(); event.preventDefault()">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" placeholder="e.g. guest" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" placeholder="Any password" required>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary btn-lg w-100">Login</button>
                        </div>
                    </form>
                    <div id="login-error" class="alert alert-danger mt-3" style="display:none;"></div>
                </div>
                <div class="card-footer text-muted text-center small">
                    GopherID Secure Server v1.0
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        <div class="row">
            <div class="col-md-5 mb-4">
                <div class="card shadow-sm border-primary h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">User Profile</h5>
                    </div>
                    <div class="card-body">
                        <h1 class="display-6">Welcome, <span id="user-name">...</span>!</h1>
                        <span class="badge bg-secondary mb-3" id="user-role-badge">Role: User</span>

                        <hr>

                        <div class="card mb-3 bg-light border-warning">
                            <div class="card-body text-center p-2">
                                <h6 class="card-title text-warning-emphasis">Two-Factor Authentication</h6>
                                <button class="btn btn-sm btn-warning w-100 mb-2" onclick="setupMFA()">
                                    üîÑ Setup / Reset MFA
                                </button>

                                <div id="qrcode" class="d-flex justify-content-center my-2"></div>
                                <div id="secret-display" class="small font-monospace text-muted text-break"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Admin Flag Access</label>
                            <div class="input-group">
                                <input type="text" id="mfa-input" class="form-control" placeholder="Enter 6-digit MFA Code">
                                <button class="btn btn-danger" onclick="getFlag()">Get Flag</button>
                            </div>
                            <div class="form-text text-muted">MFA is required for this action.</div>
                        </div>

                        <div id="flag-output" class="mt-3 alert alert-secondary" style="display:none;"></div>

                        <hr>
                        <button class="btn btn-outline-secondary w-100" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>

            <div class="col-md-7 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Token Debugger</h5>
                        <small class="text-warning">Developer Mode: Active</small>
                    </div>
                    <div class="card-body bg-light">
                        <p class="small text-muted">Current Session Token (JWT):</p>

                        <div class="card mb-3">
                            <div class="card-body p-2 small">
                                <span id="raw-header" class="header-part fw-bold"></span>.<span id="raw-payload" class="payload-part fw-bold"></span>.<span id="raw-sig" class="signature-part text-muted">...</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <h6>Header</h6>
                                <pre class="console-bg p-2 rounded" id="decoded-header">{}</pre>
                            </div>
                            <div class="col-6">
                                <h6>Payload</h6>
                                <pre class="console-bg p-2 rounded" id="decoded-payload">{}</pre>
                            </div>
                        </div>

                        <div class="alert alert-info d-flex align-items-center mt-2" role="alert">
                            <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Info:"><use xlink:href="#info-fill"/></svg>
                            <small>
                                Note: This token is signed using <strong>RS256</strong>, not <strong>HS256</strong>.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    let currentToken = "";

    async function login() {
        const user = document.getElementById("username").value;
        const pass = document.getElementById("password").value;
        const errBox = document.getElementById("login-error");

        errBox.style.display = "none";

        try {
            const res = await fetch("/api/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: user, password: pass })
            });

            if (!res.ok) {
                const txt = await res.text();
                errBox.innerText = "Login Failed: " + txt;
                errBox.style.display = "block";
                return;
            }

            const data = await res.json();
            if (data.token) {
                currentToken = data.token;
                renderDashboard(currentToken);
            }
        } catch (e) {
            errBox.innerText = "Connection error.";
            errBox.style.display = "block";
        }
    }

    // New Function: Calls the Setup Endpoint and Renders QR
    async function setupMFA() {
        const qrContainer = document.getElementById("qrcode");
        const secretDisplay = document.getElementById("secret-display");

        qrContainer.innerHTML = ""; // Clear previous
        secretDisplay.innerText = "Generating keys...";

        try {
            const res = await fetch('/api/mfa/setup', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + currentToken }
            });

            if (res.ok) {
                const data = await res.json();
                if(data.url) {
                    new QRCode(qrContainer, {
                        text: data.url,
                        width: 128,
                        height: 128
                    });
                    secretDisplay.innerText = "Secret: " + (data.secret || "Hidden");
                }
            } else {
                secretDisplay.innerText = "Error: " + res.statusText;
            }
        } catch(e) {
            secretDisplay.innerText = "Connection Failed";
        }
    }

    // Modified Function: Includes MFA Header
    async function getFlag() {
        const output = document.getElementById("flag-output");
        const mfaCode = document.getElementById("mfa-input").value; // Read input

        output.style.display = "block";
        output.innerText = "Verifying permissions...";
        output.className = "mt-3 alert alert-secondary";

        try {
            const res = await fetch("/api/flag", {
                headers: {
                    "Authorization": "Bearer " + currentToken,
                    "X-MFA-Code": mfaCode // Send the header
                }
            });

            const data = await res.json();

            if (res.ok) {
                output.className = "mt-3 alert alert-success fw-bold";
                output.innerText = data.message;
            } else {
                output.className = "mt-3 alert alert-danger";
                // Display the specific error message from the server (e.g. "Invalid MFA Code")
                output.innerText = data.message || "Access Denied.";
            }
        } catch (e) {
            output.innerText = `Error connecting to server: ${e}`;
        }
    }

    function renderDashboard(token) {
        document.getElementById("login-card").style.display = "none";
        document.getElementById("dashboard").style.display = "block";

        const parts = token.split(".");
        document.getElementById("raw-header").innerText = parts[0];
        document.getElementById("raw-payload").innerText = parts[1];
        document.getElementById("raw-sig").innerText = parts[2].substring(0, 10) + "...";

        const header = JSON.parse(atob(parts[0]));
        const payload = JSON.parse(atob(parts[1]));

        document.getElementById("decoded-header").innerText = JSON.stringify(header, null, 2);
        document.getElementById("decoded-payload").innerText = JSON.stringify(payload, null, 2);

        document.getElementById("user-name").innerText = payload.username;

        const badge = document.getElementById("user-role-badge");
        badge.innerText = "Role: " + payload.role;
        badge.className = payload.role === "admin" ? "badge bg-danger mb-3" : "badge bg-secondary mb-3";
    }

    function logout() {
        currentToken = "";
        document.getElementById("dashboard").style.display = "none";
        document.getElementById("login-card").style.display = "flex";
        document.getElementById("login-error").style.display = "none";
        document.getElementById("flag-output").style.display = "none";
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        document.getElementById("qrcode").innerHTML = ""; // Clear QR
        document.getElementById("secret-display").innerText = "";
        document.getElementById("mfa-input").value = "";
    }
</script>

<!-- https://github.com/mspraggs/gopherid -->
</body>
</html>
